name: Build Mac & Windows Executable

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      MACOSX_DEPLOYMENT_TARGET: '10.15' # Target macOS Catalina and newer for maximum compatibility
    steps:
    - uses: actions/checkout@v3

    # On macOS-13 (Intel), we build natively for x64.
    # This executable will run on Intel Macs natively and on Apple Silicon Macs via Rosetta 2.

    # 2. Use setup-python to install Intel (x64) version of Python
    # This forces the environment to be x64, so PyInstaller creates an x64 binary.
    - name: Set up Python (Intel/x64)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: 'x64'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas playwright pyinstaller openpyxl

    - name: Install Playwright Browsers
      run: playwright install chromium

    - name: Build with PyInstaller (Mac)
      run: |
        # --noconsole: GUI app
        # --onefile: Single executable/bundle
        # --collect-all playwright: Essential for packing Playwright
        pyinstaller --noconfirm --onefile --noconsole --name "WorknetCrawlerGUI" --clean --collect-all playwright --hidden-import=openpyxl worknet_crawler_gui.py

    - name: Create ZIP Artifact
      run: |
        cd dist
        # Zip the .app bundle (Mac apps are directories)
        zip -r WorknetCrawlerGUI_Mac.zip WorknetCrawlerGUI.app

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-executable-zip
        path: dist/WorknetCrawlerGUI_Mac.zip

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas playwright pyinstaller openpyxl

    - name: Install Playwright Browsers
      run: playwright install chromium

    - name: Build with PyInstaller (Windows)
      run: |
        pyinstaller --noconfirm --onefile --noconsole --name "WorknetCrawlerGUI" --clean --collect-all playwright --hidden-import=openpyxl worknet_crawler_gui.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable-exe
        path: dist/WorknetCrawlerGUI.exe
